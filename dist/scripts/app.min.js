var app=app||{};app.food=Backbone.Model.extend({defaults:{brand_name:"",item_name:"",nutrient_name:"",nutrient_uom:"",nutrient_value:0,ingredient_statement:"",nutrients:"",resource_id:"",serving_qty:0,serving_uom:"",thumbnail:"",type:"new"},url:app.url+":8888/?action=i&q=",initialize:function(){this.on("model:quanity",function(){console.log("quanity change")})}});
var app=app||{};app.LocalStorage=Backbone.LocalStorage,app.foodRecord=Backbone.Model.extend({defaults:{date:app.date,period:0,quanity:0,food:""},urlRoot:app.url,sync:function(e,t,o){switch(o=o||(o={}),e){case"read":o.url=this.urlRoot+"?action=read&id="+this.get("id");break;case"delete":o.url=this.urlRoot+"?action=delete&id="+this.get("id");break;case"update":o.url=this.urlRoot+"?action=update&id="+this.get("id");break;case"create":o.url=this.urlRoot+"?action=create"}return Backbone.sync.apply(this,arguments)},localStorage:new app.LocalStorage("foodRecord"),initialize:function(){this.on("destroy",this.delete)},delete:function(){console.log("delete",this.get("date"),this.get("food"))}});
var app=app||{};app.search=Backbone.Model.extend({defaults:{id:"",text:""},initialize:function(){}});
var app=app||{};app.foodList=Backbone.Collection.extend({model:app.food,url:"",getChecked:function(){return this.where({checked:!0})},getItems:function(e,t){this.url=app.url+":8888/?action=s&q="+e,this.fetch({reset:!0,error:function(){t()}})},search:function(e){return this.filter(function(t){return t.get("title")===e})},searchID:function(e){return this.filter(function(t){return t.get("resource_id")===e})}});
var app=app||{};app.foodRecordList=Backbone.Collection.extend({model:app.foodRecord,url:"",initialize:function(){var o=root.localStorage.getItem("foodRecord"),t=[],e=this;null!=o&&(o.split(",").forEach(function(o){var e=root.localStorage.getItem("foodRecord-"+o);null!==e&&t.push(JSON.parse(e))}),e.push(t))},getItemsByDate:function(o){var t=this.where({date:o});return{foods:t,total:t.reduce(function(o,t){return o+t.get("quanity")*t.get("food").nutrient_value},0)}}});
var app=app||{};app.searchList=Backbone.Collection.extend({model:app.search,url:"",initialize:function(){this.fetchXRH=null},getItems:function(t,e){this.abortSearch(),this.url=app.url+":8888/?action=a&q="+t,this.fetchXRH=this.fetch({reset:!0,error:function(){e()}})},abortSearch:function(){null!==this.fetchXRH&&this.fetchXRH.abort()}});
var app=app||{};app.foodView=Backbone.View.extend({tagName:"li",events:{"click .addToDiet":"editReadyToAddFood"},initialize:function(){var e=this;e.detail=$("#detail"),e.addDietPanel=$("#addDiet")},template:_.template($("#food-list").html()),templateDetail:_.template($("#food-detail").html()),render:function(){return this.$el.html(this.template(this.model.attributes)),this},renderDetail:function(){var e=this;return e.detail.html(e.templateDetail(e.model.attributes)),e},fetchDetail:function(e){var t=this,i=t.model.attributes;t.model.fetch({reset:!0,url:t.model.url+i.resource_id,success:function(){t.renderDetail()}})},editReadyToAddFood:function(){var e=this;e.renderDetail(),Backbone.trigger("editFood",e.model.get("resource_id")),e.addDietPanel.removeClass("hide")},addToDiet:function(){var e=this;Backbone.trigger("addFoodRecord",JSON.parse(JSON.stringify(e.model.attributes)))}});
var app=app||{};app.LocalStorage=Backbone.LocalStorage,app.foodRecordView=Backbone.View.extend({tagName:"li",events:{"click .deleteDiet":"deleteDiet"},template:_.template($("#food-list").html()),initialize:function(){this.model.get("food").type="record"},render:function(){var e=this.model.get("food");return e.quanity=this.model.get("quanity"),this.$el.html(this.template(e)),this},deleteDiet:function(){this.$el.remove(),Backbone.trigger("removeFoodRecord",this.model)}});
var app=app||{};app.searchView=Backbone.View.extend({tagName:"li",events:{click:"search"},initialize:function(){console.log("init searchView")},render:function(){return this.$el.html(this.model.get("text")),this},search:function(){app.router.navigate("search/"+this.model.get("text"),{trigger:!0})}});
var app=app||{};app.mainView=Backbone.View.extend({el:$("#main"),initialize:function(){var e=this;e.searchInput=$("#searchText"),e.searchBtn=$(".serachDiv a"),e.list=$("#services"),e.date=$("input[name='date_submit']"),e.quanity=$("#quanity"),e.period=$("#period"),e.readyToAddId="",e.addDiet=$("#addDiet"),e.addDietBtn=$("#addDiet .add"),e.foods=new app.foodList,e.searchResults=new app.searchList,e.foodRecords=new app.foodRecordList,e.loading=$(".loading"),e.totalCal=$("#totalCal span"),e.listenTo(e.foods,"reset",e.searchFoodRender),e.listenTo(e.searchResults,"reset",e.searchResultsRender),Backbone.on("editFood",this.editFood,this),Backbone.on("removeFoodRecord",this.removeFoodRecord,this),e.searchBtn.bind("click",function(){e.searchResults.abortSearch(),Backbone.history.fragment=="search/"+e.searchInput.val()?Backbone.history.loadUrl():app.router.navigate("search/"+e.searchInput.val(),{trigger:!0,replace:!0})}),e.quanity.bind("blur",function(){var o=e.foods.searchID(e.readyToAddId);o=1==o.length?o[0]:[],$("#detail .ttlqty").html($(this).val()*o.get("serving_qty")),$("#detail .cal").html($(this).val()*o.get("nutrient_value"))}),e.addDietBtn.bind("click",function(){var o=[];parseInt(e.quanity.val())>0&&""!==e.readyToAddId&&(o=1==(o=e.foods.searchID(e.readyToAddId)).length?o[0]:[],e.addFoodRecord(o,function(){e.addDiet.addClass("hide"),app.router.navigate("/",{trigger:!0})}))}),e.searchInput.bind("keyup",function(){var o=$(this).val();$(".searchList").addClass("hide"),""!==o&&e.searchResults.getItems(o,function(){e.searchResultsRender([])})}),e.loading.addClass("hide")},searchResultsRender:function(e){var o=this,a=$(document.createDocumentFragment());e.length>0&&(o.searchResults.forEach(function(e){var o=new app.searchView({model:e});a.append(o.render().el)}),$(".searchList").html(a).removeClass("hide"))},searchFood:function(e){var o=this;""!==e&&(o.loading.removeClass("hide").addClass("processing"),o.foods.getItems(e,function(){o.searchFoodRender([])}))},searchFoodRender:function(e){var o=this,a=$(document.createDocumentFragment());e.length>0?o.foods.forEach(function(e){var o=new app.foodView({model:e});a.append(o.render().el)}):a.append("<li>Something wrong</li>"),o.render(a),o.loading.addClass("hide").removeClass("processing")},foodRecord:function(){var e=this,o=$(document.createDocumentFragment());e.foodRecords.forEach(function(e){var a=new app.foodRecordView({model:e});o.append(a.render().el)}),e.render(o)},foodRecordSearch:function(e){var o=this,a=o.foodRecords.getItemsByDate(e),t=$(document.createDocumentFragment());o.totalCal.html(a.total),a.foods.forEach(function(e){var o=new app.foodRecordView({model:e});t.append(o.render().el)}),o.render(t)},render:function(e){return this.list.append(e),this},editFood:function(e){this.readyToAddId=e},addFoodRecord:function(e,o){var a=this,t=new app.foodRecord({date:a.date.val(),period:a.period.val(),quanity:a.quanity.val(),food:e});t.save({dataType:"json"},{success:function(e,d,n){console.log("The model has been saved to the server"),a.foodRecords.push(t),o()},error:function(e,o,a){alert("fail to add"),console.log("Something went wrong while saving the model")}})},removeFoodRecord:function(e){e.destroy()}});
function getDate(t){var e=t.getFullYear(),a=t.getMonth()+1,i=t.getDate();return a=(a<10?"0":"")+a,i=(i<10?"0":"")+i,e+"-"+a+"-"+i}var root=root||{},app=app||{};app.url="http://localhost";var myRouter=Backbone.Router.extend({initialize:function(){this.app=new app.mainView,this.serachPanel=$(".serachDiv"),this.tool=$("#tool"),this.period=$("#period"),this.calendar=$(".days"),this.list=$("#services"),this.detail=$("#detail"),this.searchText=$("#searchText"),this.searchList=$(".searchList"),this.total=$("#totalCal");var t=new Date,e=t.getTime();this.today=getDate(t);for(var a=[this.today],i=1;i<=6;i++)a.push(getDate(new Date(e-864e5*i)));this.calendar.html(a.reduce(function(t,e,a){return'<li data-day="'+e+'"><a href="#foodRecordDate/'+e+'">'+e.substr(8,2)+"</a></li>"+t},"")),$(".datepicker").val(this.today)},init:function(){this.serachPanel.addClass("hide"),this.calendar.addClass("hide"),this.tool.addClass("hide"),this.searchList.addClass("hide"),this.total.addClass("hide"),this.list.empty(),this.searchList.empty(),this.detail.empty()},routes:{"":"seachfoodRecordByDate","startSearch/:period":"startSearch","search/:value":"searchFood","foodRecordDate/:date":"seachfoodRecordByDate"},startSearch:function(t){this.init(),this.serachPanel.removeClass("hide"),this.period.val(t)},searchFood:function(t){this.init(),this.searchText.val(t),$("#quanity").val(1),this.serachPanel.removeClass("hide"),this.app.searchFood(t)},seachfoodRecordByDate:function(t){t||(t=this.today),this.init(),this.tool.removeClass("hide"),this.calendar.removeClass("hide"),this.total.removeClass("hide"),this.calendar.find("li").each(function(e,a){t===$(a).data("day")?$(a).addClass("cur"):$(a).removeClass("cur")}),this.app.foodRecordSearch(t)}});$(document).ready(function(){root.localStorage=localStorage,$(".closeAddDiet").bind("click",function(){$("#addDiet").addClass("hide"),$("#quanity").val(1)}),$(".openTool").bind("click",function(){$(".toolList").toggleClass("active")}),app.router=new myRouter,Backbone.history.start()});